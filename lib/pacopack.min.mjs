import{performance as e}from"perf_hooks";class t{static MAX_1BYTE_UTF8=64;static BYTELENGTH_MAX=24;static TO_STRING_MAX=24;static TO_STRING_FUNCS_MAX=54;static TO_BUFFER_MAX=54;static optimize(e=300){!function(e=300){e/=3,t.BYTELENGTH_MAX=c((()=>{}),(e=>{Buffer.byteLength(e)}),(e=>{f(e)}),e),t.TO_STRING_MAX=c((e=>Buffer.from(e)),((e,t)=>{t.toString("utf8",0)}),((e,t)=>{_(t,0,t.length)}),e),h=new Array(4*t.TO_STRING_MAX),t.TO_STRING_FUNCS_MAX=c((e=>Buffer.from(e)),((e,i)=>{e.length<=t.TO_STRING_MAX?_(i,0,i.length):i.toString("utf8",0)}),((e,t)=>{i[e.length-1](t,0)}),e,i.length),t.TO_BUFFER_MAX=c((e=>Buffer.allocUnsafe(4*e.length)),((e,t)=>{t.write(e,0)}),((e,i)=>{t.toBuffer(e,i,0)}),e)}(e)}static byteLength(e){return f(e)}static toBuffer(e,i,s){if(e.length<=t.TO_BUFFER_MAX)return function(e,t,i){let s=!1,r=i;for(let r=0;r<e.length;r++){let h=t[i++]=e.charCodeAt(r);h>=128&&(h<2048?(t[i-1]=192|h>>6,t[i++]=128|63&h):h<55296||h>=57344?(t[i-1]=224|h>>12,t[i++]=128|h>>6&63,t[i++]=128|63&h):(r++,s=!0,h=65536+((1023&h)<<10|1023&e.charCodeAt(r)),t[i-1]=240|h>>18,t[i++]=128|h>>12&63,t[i++]=128|h>>6&63,t[i++]=128|63&h))}return{size:i-r,isQuad:s}}(e,i,s);return{size:i.write(e,s),isQuad:!0}}static toString(e,s,r,h,f){return f||r>t.TO_STRING_FUNCS_MAX?r<=t.TO_STRING_MAX?_(e,s,s+h):e.toString("utf8",s,s+h):i[r](e,s)}}const i=[];function s(e){let t=`v${e}`;return`let ${t} = buffer[offset++];\nif (${t} >= 0x80) {\n    if (${t} > 0xBF && ${t} < 0xE0) {\n        ${t} = (${t} & 0x1F) << 6 | buffer[offset++] & 0x3F;\n    } else {\n        ${t} = (${t} & 0x0F) << 12 | (buffer[offset] & 0x3F) << 6 | buffer[offset + 1] & 0x3F;\n        offset += 2;\n    }\n}`}function r(e,t){return(e=e.slice()).push(`return String.fromCharCode(${function(e){return new Array(e+1).fill(0).map(((e,t)=>`v${t}`)).join(",")}(t)});`),new Function("buffer","offset",e.join("\r\n"))}!function(){let e=[];i.push((()=>""));for(let h=0;h<t.MAX_1BYTE_UTF8;h++)e.push(s(h)),i.push(r(e,h))}();let h=new Array(4*t.TO_STRING_MAX);function _(e,t,i){let s=0;for(let r=t;r<i;r++){let t=e[r];if(255===t)break;if(t<128)h[s++]=t;else if(t>191&&t<224)h[s++]=(31&t)<<6|63&e[r+1],r+=1;else if(t>223&&t<240)h[s++]=(15&t)<<12|(63&e[r+1])<<6|63&e[r+2],r+=2;else{let i=((7&t)<<18|(63&e[r+1])<<12|(63&e[r+2])<<6|63&e[r+3])-65536;h[s++]=i>>10|55296,h[s++]=1023&i|56320,r+=3}}return String.fromCharCode(...h.slice(0,s))}function f(e){let t=e.length;for(let i=e.length-1;i>=0;i--){let s=e.charCodeAt(i);s>127&&(s<2048?t++:s<65536&&(t+=2),s>=56320&&s<57344&&i--)}return t}function o(t,...i){let s=0,r=25;for(let h=0;h<25;h++){let _=e.now();for(let e=0;e<r;e++)t(...i);let f=(e.now()-_)/(r/25);f?s=0==s?f:(s+f)/2:(r*=2,h--)}return s}function n(e,t,...i){return o(e,...i)>o(t,...i)?1:2}function c(t,i,s,r,h=1/0){let _=4,f=-1,o=e.now();for(;;){let c=Buffer.allocUnsafe(_).fill(100).toString(),a=n(i,s,c,t(c));if(2===a&&(_-=4),(2===a||_>=h)&&(f=-1==f?_:(f+_)/2,_=0),_+=4,e.now()-o>r)break}return f>-1?Math.round(f):1/0}const a=Symbol();class u{toJSON;static _B64=18446744073709551615n;_buffer=Buffer.allocUnsafe(0);_dataView=new DataView(this._buffer.buffer);_bufferArray=[];_totalBuffer=0;_pos=0;_size=0;_strIndex=0;_strMap={};_dirtyStringMap=!0;_receiveStrMap={};_receiveStrMapIndex=0;_receivePos=0;dictionary=null;options={step:512};constructor(e,t,i){this.toJSON=i,e&&this.setOptions(e),t&&(this._setDictionary(t),this.resetStringMap(),this._resetReceiveStringMap())}static _BigInt64BlocksCount(e){let t=0;for(;e>0n;)e>>=64n,t++;return t}static _WriteBigUint(e,t,i){for(;i>0n;){let s=i&this._B64;i>>=64n,e.writeBigUInt64LE(s,t),t+=8}}static _WriteBigUintDataView(e,t,i){for(;i>0n;){let s=i&this._B64;i>>=64n,e.setBigUint64(t,s,!0),t+=8}}static _ReadBigUint(e,t,i){let s=0n,r=0n,h=BigInt(i);for(;r<h;){let i=e.readBigUInt64LE(t);t+=8,s+=i<<64n*r,r++}return s}static OptimizeStrings(e=300){return t.optimize(e),t}_setDictionary(e){if(Array.isArray(e)){let t={words:{},total:e.length,dictionary:{}};for(let i=0;i<e.length;i++){let s=e[i];t.words[s]={[a]:i},t.dictionary[i]=e[i]}e=t}return this.dictionary=e}_resetReceiveStringMap(){this.dictionary?(this._receiveStrMap={...this.dictionary.dictionary},this._receiveStrMapIndex=this.dictionary.total):(this._receiveStrMap={},this._receiveStrMapIndex=0)}_read(e){let i=e[this._receivePos++];if(128==(128&i)){let t=0;switch(7&i){case 1:t=e[this._receivePos++];break;case 2:t=e[this._receivePos]+(e[this._receivePos+1]<<8),this._receivePos+=2;break;case 3:t=e[this._receivePos]+(e[this._receivePos+1]<<8)+(e[this._receivePos+2]<<16),this._receivePos+=3;break;case 4:t=e[this._receivePos]+(e[this._receivePos+1]<<8)+(e[this._receivePos+2]<<16)+(e[this._receivePos+3]<<24>>>0),this._receivePos+=4;break;case 5:t=e[this._receivePos]+(e[this._receivePos+1]<<8)+(e[this._receivePos+2]<<16)+(e[this._receivePos+3]<<24>>>0)+4294967296*e[this._receivePos+4],this._receivePos+=5;break;case 6:t=e[this._receivePos]+(e[this._receivePos+1]<<8)+(e[this._receivePos+2]<<16)+(e[this._receivePos+3]<<24>>>0)+4294967296*(e[this._receivePos+4]+(e[this._receivePos+5]<<8)),this._receivePos+=6;break;case 7:t=e.readDoubleLE(this._receivePos),this._receivePos+=8}switch(240&i){case 144:return this._receiveStrMap[t];case 224:return e.toString("utf8",this._receivePos,this._receivePos+=t);case 240:return this._receiveStrMap[this._receiveStrMapIndex++]=e.toString("utf8",this._receivePos,this._receivePos+=t);case 128:return 8==(8&i)?-t:t;case 192:return BigInt(8==(8&i)?-t:t);case 160:{let t=e[this._receivePos],s=u._ReadBigUint(e,this._receivePos+1,t);return this._receivePos+=1+8*t,8==(8&i)?-s:s}case 208:return new Date(t);case 176:return e.slice(this._receivePos,this._receivePos+=t)}}else switch(i){case 14:{let i=e[this._receivePos],s=e[this._receivePos+1],r=128&i;i&=127;const h=t.toString(e,this._receivePos+2,i,s,r);return this._receivePos+=2+s,h}case 13:{let i=e[this._receivePos],s=e[this._receivePos+1],r=128&i;i&=127;const h=this._receiveStrMap[this._receiveStrMapIndex++]=t.toString(e,this._receivePos+2,i,s,r);return this._receivePos+=2+s,h}case 0:return null;case 1:return;case 2:return!0;case 3:return!1;case 15:{let t=this._read(e),i=e[this._receivePos++],s=1&i?"g":"";return 2&i&&(s+="m"),4&i&&(s+="s"),8&i&&(s+="i"),16&i&&(s+="u"),new RegExp(t,s)}case 4:{let t=[];for(;5!==e[this._receivePos];)t.push(this._read(e));return this._receivePos++,t}case 6:{let t={};for(;7!==e[this._receivePos];){t[this._read(e)]=this._read(e)}return this._receivePos++,t}case 10:{let t=new Set;for(;11!==e[this._receivePos];)t.add(this._read(e));return this._receivePos++,t}case 8:{let t=new Map;for(;9!==e[this._receivePos];){let i=this._read(e);t.set(i,this._read(e))}return this._receivePos++,t}}throw new Error("Invalid buffer")}_write(e){switch(typeof e){case"object":if(null===e)this._checkSize(1),this._buffer[this._pos++]=0;else if(e instanceof Uint8Array)this._writeInteger(e.length,176,0),this._slice(),this._bufferArray.push(e),this._totalBuffer+=e.length;else if(Array.isArray(e)){this._checkSize(2+2*e.length),this._buffer[this._pos++]=4;for(let t of e)this._write(t);this._checkSize(1),this._buffer[this._pos++]=5}else if(e instanceof Set){this._checkSize(2+2*e.size),this._buffer[this._pos++]=10;for(let t of e)this._write(t);this._checkSize(1),this._buffer[this._pos++]=11}else if(e instanceof Map){this._checkSize(2+5*e.size),this._buffer[this._pos++]=8;for(let[t,i]of e)this._write(t),this._write(i);this._checkSize(1),this._buffer[this._pos++]=9}else if(e instanceof RegExp)this._checkSize(2+e.source.length+e.flags.length),this._buffer[this._pos++]=15,this._writeString(e.source,!1),this._checkSize(1),this._buffer[this._pos++]=1*e.global+2*e.multiline+4*e.dotAll+8*e.ignoreCase+16*e.unicode;else if(e instanceof Date)this._writeInteger(e.getTime(),208,0);else if(this.toJSON&&"function"==typeof e.toJSON)this._write(e.toJSON());else{if(this.options.sortKeys){let t=Object.keys(e);t.sort(),this._checkSize(2+5*t.length),this._buffer[this._pos++]=6;for(let i of t)this._writeString(i,!0),this._write(e[i])}else{this._checkSize(2),this._buffer[this._pos++]=6;for(let t in e)this._writeString(t,!0),this._write(e[t])}this._checkSize(1),this._buffer[this._pos++]=7}break;case"string":this._writeString(e,!1);break;case"number":{let t=0;e<0&&(t=8,e=-e),Number.isInteger(e)?this._writeInteger(e,128+t,0):this._writeDouble(e,128+t,0);break}case"bigint":{let t=0;if(e<0n&&(t=8,e=-e),e<=0xffffffffffffn)this._writeInteger(Number(e),192+t,0);else{let i=u._BigInt64BlocksCount(e),s=8*i;this._checkSize(2+s),this._buffer[this._pos]=160+t,this._buffer[this._pos+1]=i,u._WriteBigUintDataView(this._dataView,this._pos+2,e),this._pos+=2+s}break}case"boolean":this._checkSize(1),this._buffer[this._pos++]=e?2:3;break;case"undefined":this._checkSize(1),this._buffer[this._pos++]=1}}_checkSize(e){this._pos+e>this._size&&(this._pos>0&&(this._bufferArray.push(this._buffer.slice(0,this._pos)),this._totalBuffer+=this._pos),this._buffer=Buffer.allocUnsafe(this._size=Math.max(this.options.step,e)),this._dataView=new DataView(this._buffer.buffer,this._buffer.byteOffset,this._buffer.byteLength),this._pos=0)}_slice(){this._pos>0&&(this._bufferArray.push(this._buffer.slice(0,this._pos)),this._totalBuffer+=this._pos),this._buffer=Buffer.allocUnsafe(this._size=this.options.step),this._dataView=new DataView(this._buffer.buffer,this._buffer.byteOffset,this._buffer.byteLength),this._pos=0}_writeString(e,i){let s=this._strMap[e];if(s&&s[a]>-1)this._writeInteger(s[a],144,0);else if(e.length<=t.MAX_1BYTE_UTF8){let s=e.length;this._checkSize(3+4*s),i?(this._strMap[e]={[a]:this._strIndex++},this._buffer[this._pos]=13):this._buffer[this._pos]=14;let r=t.toBuffer(e,this._buffer,this._pos+3);r.isQuad&&(s+=128),this._buffer[this._pos+1]=s,this._buffer[this._pos+2]=r.size,this._pos+=3+r.size}else{let s=t.byteLength(e);i?(this._strMap[e]={[a]:this._strIndex++},this._writeInteger(s,240,s)):this._writeInteger(s,224,s),this._buffer.write(e,this._pos),this._pos+=s}}_writeInteger(e,t,i){0===e?(this._checkSize(1+i),this._buffer[this._pos++]=t):e<=255?(this._checkSize(2+i),this._buffer[this._pos]=t+1,this._buffer[this._pos+1]=e,this._pos+=2):e<=65535?(this._checkSize(3+i),this._buffer[this._pos]=t+2,this._buffer[this._pos+1]=e,this._buffer[this._pos+2]=e>>8,this._pos+=3):e<=16777215?(this._checkSize(4+i),this._buffer[this._pos]=t+3,this._buffer[this._pos+1]=e,this._buffer[this._pos+2]=e>>8,this._buffer[this._pos+3]=e>>16,this._pos+=4):e<=4294967295?(this._checkSize(5+i),this._buffer[this._pos]=t+4,this._buffer[this._pos+1]=e,this._buffer[this._pos+2]=e>>>8,this._buffer[this._pos+3]=e>>>16,this._buffer[this._pos+4]=e>>>24,this._pos+=5):e<=0xffffffffff?(this._checkSize(6+i),this._buffer[this._pos]=t+5,this._buffer[this._pos+1]=e,this._buffer[this._pos+2]=e>>>8,this._buffer[this._pos+3]=e>>>16,this._buffer[this._pos+4]=e>>>24,this._buffer[this._pos+5]=e/4294967296,this._pos+=6):e<=0xffffffffffff?(this._checkSize(7+i),this._buffer[this._pos]=t+6,this._buffer[this._pos+1]=e,this._buffer[this._pos+2]=e>>>8,this._buffer[this._pos+3]=e>>>16,this._buffer[this._pos+4]=e>>>24,e/=4294967296,this._buffer[this._pos+5]=e,this._buffer[this._pos+6]=e>>8,this._pos+=7):this._writeDouble(e,t,i)}_writeDouble(e,t,i){this._checkSize(9+i),this._buffer[this._pos]=t+7,this._dataView.setFloat64(this._pos+1,e,!0),this._pos+=9}_get(e){let t;return 0===this._bufferArray.length?(t=this._buffer.slice(0,this._pos),e||(t=Buffer.from(t))):(this._pos>0&&(this._bufferArray.push(this._buffer.slice(0,this._pos)),this._totalBuffer+=this._pos),t=Buffer.concat(this._bufferArray,this._totalBuffer),this._bufferArray=[],this._totalBuffer=0),t}resetStringMap(){this.dictionary?(this._strMap=Object.create(this.dictionary.words),this._strIndex=this.dictionary.total):(this._strMap={},this._strIndex=0),this._dirtyStringMap=!0}setOptions(e){this.options={step:512,...e}}serialize(e,t=0,i=!1){return this._pos=t,(0===this._size||this._size<this._pos)&&(this._buffer=Buffer.allocUnsafe(this._size=this.options.step),this._dataView=new DataView(this._buffer.buffer,this._buffer.byteOffset,this._buffer.byteLength)),this.options.mapKeys||this.resetStringMap(),this._dirtyStringMap?this._dirtyStringMap=!1:this._buffer[this._pos++]=12,this._write(e),this._get(i)}deserialize(e){return this._receivePos=0,12!==e[this._receivePos]?this._resetReceiveStringMap():this._receivePos++,this._read(e)}}export{u as PacoPack,t as UTF8};
